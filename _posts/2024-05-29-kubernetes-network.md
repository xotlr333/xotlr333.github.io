---
layout: post
title: 4. 쿠버네티스 통신
date: 2024-05-27
categories: [Kubernetes, 2.쿠버네티스 기본 개념]
tags: [쿠버네티스, 서비스]
---

### 파드가 사용하는 네트워크와 호스트(노드)가 사용하는 네트워크는 다릅니다

- 노드 내의 파드들은 가상의 네트워크(파드 및 컨테이너가 사용하는 네트워크)를 사용하고, 호스트는 물리 네트워크(마스터 및 워커 노드가 사용하는 네트워크)를 사용합니다.

### 같은 노드에 떠 있는 파드끼리만 통신할 수 있습니다

- 같은 노드에 떠 있는 파드끼리는 통신이 가능하지만, 다른 노드의 파드 또는 외부와의 통신은 불가능합니다.

### 다른 노드의 파드와 통신하려면 CNI 플러그인이 필요합니다

- **CNI(Container Network Interface)**는 **컨테이너 간의 통신을 위한 네트워크 인터페이스**입니다.

## 같은 파드에 포함된 컨테이너 간 통신

- 같은 파드 내에 있는 컨테이너 간의 통신은 **직접 통신**이 가능합니다.
- 하나의 파드에는 하나의 가상 네트워크가 생성되며, 그 파드 내에 존재하는 컨테이너들은 같은 가상 네트워크를 사용합니다.
- 따라서 **하나의 파드 내에 존재하는 컨테이너들은 모두 동일한 IP를 사용**합니다.
- 컨테이너들은 **포트번호를 이용해 구분**합니다.

![Untitled](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/f4ea6b8c-6b92-4f87-a105-465a826ed4a0)

## 단일 노드에서 파드 간 통신

- 단일 노트에 떠 있는 파드들은 같은 대역(veth: 172.10.0.1, veth: 172.10.0.2 등)을 사용하므로 docker0이라는 **브리지를 통해 서로 통신**합니다.

![Untitled 1](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/c4329cd8-4fa2-4c91-aaca-1ce6a054696b)

## 다수의 노드에서 파드 간 통신

- 다수 노드에 떠 있는 파드 간의 통신할 경우 파드의 IP가 동일한 경우가 있을 수 있습니다.

![Untitled 2](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/243d9ec2-7fa0-45e3-bcfe-0cb797af3a9d)

- 이러한 문제를 해결할 수 있는 방법이 **오버레이 네트워크**입니다.
- 오버레이 네트워크란 **노드에서 사용하는 물리적인 네트워크 위에 가상의 네트워크를 구성하는 것**입니다.
- 오버레이 네트워크를 사용하면 **쿠버네티스 클러스터로 묶인 모든 노드에 떠 있는 파드 간의 통신이 가능**해집니다.
- 쿠버네티스는 오버레이 네트워크를 구성하기 위해 클러스터를 구성할 때 CNI 규약을 따르는 플러그인이 필요합니다.
- 기본적으로 쿠버넷(kubenet)이라는 간단한 네트워크 플러그인을 제공하지만 고급 기능을 제공하지 않습니다.
- 따라서 CNI의 스펙을 준수하는 네트워크 플러그인을 사용해야합니다.

![Untitled 3](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/3aa50362-41b6-423d-81b6-03fd60a19bf4)

- CNI 플러그인의 대표적인 것으로 **플라넬(flannel)**이 있습니다.
- 플라넬이 설치하면 다음과 같은 순서로 통신합니다.

![Untitled 4](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/e8f1da14-f3d2-4257-9af2-eac49732619a)

### 쿠버네티스에서 사용할 수 있는 CNI 플러그인

- **플라넬(Flannel)** : 쿠버네티스와 함께 사용할 수 있는 오버레이 네트워크 플러그인입니다.
- **칼리코(Calico)** : 캡슐화 또는 오버레이 없이 파드 간에 통신이 가능한 네트워크를 제공하는 플러그인입니다.
- **실리움(Cilium)** : 리눅스 커널 기술을 이용해 데이터 경로의 필터링, 트래픽 모니터링 및 리디렉션을 수행합니다.
- **멀터스(Multus)** : 쿠버네티스에서 다중 네트워크 지원을 위한 멀티 플러그인으로 2개 이상의 플러그인을 사용할 때 유용합니다.

## 파드와 서비스 간의 통신

### 서비스의 특성

1. 서비스도 파드처럼 IP를 갖습니다.
2. 파드와 서비스에서 사용하는 IP 대역은 다릅니다.
3. 서비스에서 사용하는 가상 네트워크는 **ifconfig나 라우팅 테이블에서 확인할 수 없습니다**.

### 서비스 네트워크의 구조와 동작 방식

![Untitled 5](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/bbf78347-33c0-4f77-8e9e-b02be6eab44d)

- Client 파드가 네트워크를 통해 Web server 파드에 http를 요청하는 과정입니다.
- Client 파드가 서비스 이름(service-request)으로 http 요청을 합니다.
- 이후 클러스터 DNS 서버는 서비스 이름(service-request)에 해당하는 서비스 IP(10.5.1.10)를 Client 파드에 전달합니다.
- 서비스 IP를 전달 받은 Client 파드는 해당 IP를 이용해 http 요청을 합니다.
- 이때 워커 노드1이라는 호스트에서는 자신의 라우팅 테이블에 10.5.1.10이라는 IP가 있는지 검색합니다.
- 검색 결과 IP가 없으면 해당 요청을 라우터/게이트웨이로 전달합니다.
- 그런데 다른 워커 노드에서도 10.5.1.10이라는 IP는 찾을 수 없을 것입니다.

- 10.5.1.10이라는 서비스 IP로 Web Server 파드(IP: 10.1.2.2)를 찾을 수 있는 방법은 리눅스 커널에서 제공하는 **netfilter**와 **iptables** 덕분입니다.
- **netfilter**란 **규칙 기반의 패킷 처리 엔진**입니다. 따라서 **서비스 IP를 특정 IP로 변경할 수 있는 규칙을 저장하고 변환하는 역할**을 합니다.

![Untitled 6](https://github.com/xotlr333/xotlr333.github.io/assets/81614820/4fb005d0-fab7-4df4-b35b-bbe41ef499d5)

- netfilter에서 서비스 IP(10.5.1.10)를 만나면 서버 IP(10.200.0.1)로 변환하고 라우터/게이트웨이로 패킷을 전달합니다.
- 이후 라우터/게이트웨이를 거쳐서 워크 노드2의 Wev Server 파드에 접근할 수 있습니다.

## 외부와 서비스 간 통신

- 서비스는 클러스터 내부적으로만 통신할 수 있게끔 설계되어있지만, 파드는 외부와의 통신도 필요합니다.
- 즉, 외부와 통신할 수 있게 다음과 같은 서비스 유형을 제공하고 있습니다.

### 노드포트(NodePort)

- 노트포트란 말 그대로 **노드 IP(eth)에 포트를 붙여서 외부에 노출시키는 것**을 말합니다.

### 로드밸런서(LoadBalancer)

- 로드밸런서는 **AWS, 애저와 같은 퍼블릭 클라우드에서 지원하는 쿠버네티스 로드밸런서 장비를 사용**합니다.
- 클라우드에서 제공하는 **로드밸런서와 파드를 연결한 후 해당 로드밸런서 IP를 이용해 클러스터 외부에서 내부로 접근**할 수 있도록 해줍니다.

### 인그레스(Ingress)

- 인그레스는 **클러스터 외부에서 내부로 접근하는 요청들을 어떻게 처리할지에 관한 규칙 모음**입니다.
- 인그레스 자체는 클러스터 외부에서 URL로 접근할 수 있도록 로드밸런싱, SSL 인증서 처리 등의 규칙을 정의한 것뿐이고, 실제로 동작시키는 것은 인그레스 컨트롤러입니다.




---
참고)  
도서-쉽게 시작하는 쿠버네티스